<%= stylesheet_link_tag "style-header.css" %>

<% if (false) %> <!-- user not connected-->
	<%= render "pages/signin" %>

<% else %>
	<%= render "pages/navbar" %>

	<div class="container-fluide body-page" id="inside-page">
		<%= render "pages/log" %>
		<%= render "pages/live" %>
		<%= render "pages/play" %>
		<%= render "pages/guild" %>
		<%= render "pages/option" %>
		<%= render "pages/profil" %>
		<%= render "pages/tournament" %>
		<%= render "pages/war" %>
		<%= render "pages/all_guild" %>


		<%= render "pages/chat/param" %>
		<%= render "pages/chat/create" %>
		<%= render "pages/chat/main" %>
	</div>
<% end %>

<script>


// _____________________________________ MODELS/COLLECTIONS _____________________________________________


var User = Backbone.Model.extend({
	urlRoot: "/users",

	defaults: {
		name: 'test',
		avatar: 'test',
		current_status: 'Online',
		points: 42,
		is_admin: true,
	},

	initialize : function() {
		console.log("UserModel created");
	  },

});

var Users = Backbone.Collection.extend({
	modele: User,
	url: "/users",

	initialize : function() {
		console.log("UserCollection created");
		this.fetch({reset: true});
	}
});

var usercollection = new Users();


var Guild = Backbone.Model.extend({
	defaults:{
		name: "",
		anagram: "",
		points:"",
		owner:"",
		officer:"" 
	}
});

var Guilds = Backbone.Collection.extend({
	model: Guild,
});

/*****Test guild ***/
var guild_1 = new Guild({
	name: "Guild of war",
	anagram: "GOF",
	points:"1234",
	owner:"didier",
	officer:"" // set empty string for no officer
});
var guild_2 = new Guild({
	name: "Les zouzes",
	anagram: "SOS",
	points:"5866",
	owner:"sapien",
	officer:"homo" // set empty string for no officer
});
var guild_3 = new Guild({
	name: "Les toros",
	anagram: "RED",
	points:"41",
	owner:"vicache",
	officer:"los" // set empty string for no officer
});

var guilds = new Guilds([guild_1, guild_2, guild_3]);


// __________________________________________ VIEWS ___________________________________________________


var LogView = Backbone.View.extend({                                                                       // --> Log
	el : '#inside-page',
	template: _.template($('#log-template').html()),
	collection: usercollection,

	initialize : function() {
		console.log("LogView created");
		this.listenTo(this.collection, 'add remove', this.render, this);
		this.collection.url = "/users.json";
	  	this.collection.fetch();
	  	console.log(this.collection.toJSON());
	},

	events: {
    	"click #add-user": "add",
    	"click #delete-user": "delete",
    	"click #sign-in ": "sign",
  	},

	render : function() {
	  	console.log("Render Log");
		this.$el.html(this.template({usr: this.collection.toJSON()}));
	  	return this;

	},

	add: function() {
		console.log("Add user");
		var user = new User({name : 'test'});
		this.collection.create(user);
		this.render();
	 },
	 
  	delete: function() {
		console.log("Delete user");
		var users = this.collection.toJSON();
		var user = users[users.length - 1];
		if (user){
			var to_delete = this.collection.get(user.id);
	  		this.collection.url = "/users"
			to_delete.destroy();
	  		console.log(this.collection.toJSON());
			this.render();
		}	
	 },
	  
	sign: function() {
		let http 			= "https://api.intra.42.fr/oauth/authorize?";
		let client 			= "client_id=235a071025e8e19cdd302e0cff45e29c2b7c2a8b1fd37bc7cdbf4e2edc452729&";
		let redirect 		= "redirect_uri=http%3A%2F%2Flocalhost%3A3000%2F&";
		let response_type 	= "response_type=code&";
		let scope 			= "scope=public&";
		let state 			= "state=a_very_long_random_string_witchmust_be_unguessable'";

		let full 			= http + client + redirect + response_type + scope + state;
		console.log("full:" + full);
		window.location.href = full;
		console.log("Delete user");
	},

})


var ChatView = Backbone.View.extend({                                                                      // --> Chat
	template_chat_main: _.template($('#chat_main-template').html()),
	template_chat_param: _.template($('#chat_param-template').html()),
	template_chat_create: _.template($('#chat_create-template').html()),
	
	events: {
		"click #main_chat_to_param": "render_chat_param",
		"click #main_chat_to_create": "render_chat_create",
		"click #back_to_main_chat": "render_chat_main"
	},

	render_chat_param : function() {
		this.$el.html(this.template_chat_param);
	},
	render_chat_create : function() {
		this.$el.html(this.template_chat_create);
	},
	render_chat_main : function() {
		this.$el.html(this.template_chat_main);
	}
});

var chatview = new ChatView();


var GuildView = Backbone.View.extend({                                                                      // --> Guild
	el : '#inside-page',
	template: _.template($('#guild-template').html()),
	template_all_guild: _.template($('#all_guild-template').html()),

	initialize : function() {
		console.log("GuildView created");
	},

	events: {
		"click #all_guild_btn": "render_all_guild",
		"click #back_to_guild": "render"
	},

	render : function() {
		this.$el.html(this.template);
		console.log("Render Guild");
		return this;
	},
	render_all_guild : function(){
		this.$el.html(this.template_all_guild);
		return this;
	}
})


var LiveView = Backbone.View.extend({                                                                      // --> Live
	el : '#inside-page',
	template: _.template($('#live-template').html()),

	initialize : function() {
		console.log("LiveView created");
	},

	render : function() {
		this.$el.html(this.template);
        chatview.setElement("#live_chat_area").render_chat_main(); // https://solvemprobler.com/blog/2013/04/07/backbone-tips-rendering-views-and-their-childviews/
		console.log("Render Live");
		return this;
	},
})


var OptionView = Backbone.View.extend({                                                                      // --> Option
	el : '#inside-page',
	template: _.template($('#option-template').html()),
  
	initialize : function() {
		console.log("OptionView created");
	},
  
	render : function() {
	  this.$el.html(this.template);
		console.log("Render Option");
		return this;
	}
});


var PlayView = Backbone.View.extend({                                                                      // --> Play
	el : '#inside-page',
	template: _.template($('#play-template').html()),
	
	initialize : function() {
		console.log("PlayView created");
	},

	render : function() {
		this.$el.html(this.template);
		chatview.setElement("#play_chat_area").render_chat_main(); // https://solvemprobler.com/blog/2013/04/07/backbone-tips-rendering-views-and-their-childviews/
		console.log("Render Play");
		return this;
	}
})


var ProfilView = Backbone.View.extend({                                                                      // --> Profil
	el : '#inside-page',
	template: _.template($('#profil-template').html()),
  
	initialize : function() {
		console.log("ProfilView created");
	},
  
	render : function() {
	  this.$el.html(this.template);
		console.log("Render Profil");
		return this;
	}
  });


var TournamentView = Backbone.View.extend({                                                                      // --> Tournament
	el : '#inside-page',
	template: _.template($('#tournament-template').html()),
  
	initialize : function() {
		console.log("TournamentView created");
	},
  
	render : function() {
	  this.$el.html(this.template);
		console.log("Render Tournament");
		return this;
	}
});


var WarView = Backbone.View.extend({                                                                           // --> War
	el : '#inside-page',
	template: _.template($('#war-template').html()),
	template_guilds: _.template($('#war-guild-template').html()),
	collection: guilds,
	model: null,

	initialize : function() {
		this.model= this.collection.first();
	},
	events: {
		"change #guild_drop_down": "render_guild_info"
	},
	render_guild_info : function() {
		var guild_name = $("#guild_drop_down option:selected").text();
		var guild_to_print = this.collection.findWhere({name: guild_name});
		console.log("change", guild_name);
		console.log("model", guild_to_print.attributes);
		this.model = guild_to_print;
		this.$('.war_pannel_header').html(this.template_guilds(this.model.toJSON()));
	},
	render : function() {
		this.$el.html(this.template(this.model.toJSON()));
		this.$('.war_pannel_header').html(this.template_guilds(this.model.toJSON()));

		// Try do modify template before rendering
		_.each(this.collection.toJSON(), function(model){
			$('#guild_drop_down').append(
				$('<option></option>').html(model.name)
			);
		});

		return this;
	}
});

// _________________________________________ ROUTER ___________________________________________________


var logview = new LogView();
var liveview = new LiveView();
var playview = new PlayView();
var guildview = new GuildView();
var optionview = new OptionView();
var profilview = new ProfilView();
var tournamentview = new TournamentView();
var warview = new WarView();

var Router = Backbone.Router.extend({
	routes: {
		'': "ft_log",
		'live': "ft_live",
		'play': "ft_play",
		'guild': "ft_guild",
		'option': "ft_option",
		'profil': "ft_profil",
		'tournament': "ft_tournament",
		'war': "ft_war",
	},
	ft_log: function() {
		logview.render();
	},
	ft_live: function() {
		liveview.render();
	},
	ft_play: function() {
		playview.render();
	},
	ft_guild: function() {
		guildview.render();
	},
	ft_option: function() {
		optionview.render();
	},
	ft_profil: function() {
		profilview.render();
	},
	ft_tournament: function() {
		tournamentview.render();
	},
	ft_war: function() {
		warview.render();
	},
});

$( "#logo" ).on( "click", function() {
	Backbone.history.navigate("/", {trigger: true});
});
$( "#nav_to_live" ).on( "click", function() {
	Backbone.history.navigate("/live", {trigger: true});
});
$( "#nav_to_play" ).on( "click", function() {
	Backbone.history.navigate("/play", {trigger: true});
});
$( "#nav_to_guild" ).on( "click", function() {
	Backbone.history.navigate("/guild", {trigger: true});
});
$( "#nav_to_option" ).on( "click", function() {
	Backbone.history.navigate("/option", {trigger: true});
});
$( "#nav_to_profil" ).on( "click", function() {
	Backbone.history.navigate("/profil", {trigger: true});
});
$( "#nav_to_tournament" ).on( "click", function() {
	Backbone.history.navigate("/tournament", {trigger: true});
});
$( "#nav_to_war" ).on( "click", function() {
	Backbone.history.navigate("/war", {trigger: true});
});

var router = new Router();

Backbone.history.start();

</script>